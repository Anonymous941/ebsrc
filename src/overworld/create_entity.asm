
; index == -1 means create new entity
; int CreateEntity(int sprite, int actionScript, int index, int x, int y)
CREATE_ENTITY: ;$C01E49
	REP #PROC_FLAGS::ACCUM8 | PROC_FLAGS::INDEX8 | PROC_FLAGS::CARRY
	RESERVE_STACK_SPACE 49
	STY $04
	PHA
	LDA $04
	STA $2F
	PLA
	STX $2D
	STA $2B
	LDY $41
	STY $29
	LDX $3F
	STX $27
	LDA DEBUG
	BEQ @UNKNOWN0
	LDA $2B
	CMP #$FFFF
	BNE @UNKNOWN0
	LDA #$0000
	JMP @UNKNOWN8
@UNKNOWN0:
	LOADPTR SPRITE_GROUPING_PTR_TABLE, $0A
	LDA $2B
	OPTIMIZED_MULT $04, 4
	CLC
	ADC $0A
	STA $0A
	DEREFERENCE_PTR_TO $0A, $06
	MOVE_INT $06, $23
	LDA $2B
	JSR UNKNOWN_C01DED
	STA $02
	LDY $04
	LDX UNKNOWN_7E467C
	LDA UNKNOWN_7E467A
	JSL UNKNOWN_C01C52
	STA $21
@UNKNOWN1:
	LDA $21
	CMP #$7FFF
	BGT @UNKNOWN1
	LOADPTR UNKNOWN_C42B0D, $06
	LDA $02
	OPTIMIZED_MULT $04, 4
	CLC
	ADC $06
	STA $06
	DEREFERENCE_PTR_TO $06, $0A
	LDA [$0A]
	AND #$00FF
	OPTIMIZED_MULT $04, 10
	JSL FIND_FREE_7E4682
	STA $1F
@UNKNOWN3:
	LDA $1F
	CMP #$7FFF
	BGT @UNKNOWN3
	LDA #$0001
	STA NEW_ENTITY_PRIORITY
.IF .DEFINED(JPN)
	MOVE_INT $0A, $0E
.ELSE
	MOVE_INT $0A, $06
	MOVE_INT $06, $0E
.ENDIF
	MOVE_INT $23, $06
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0003
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	TAY
	LDX $21
	LDA $1F
	JSR UNKNOWN_C01D38
	LDA $2F
	STA $04
	CMP #$FFFF
	BEQ @UNKNOWN5
	LDA $04
	STA ENTITY_ALLOCATION_MIN_SLOT
	LDA $04
	INC
	STA ENTITY_ALLOCATION_MAX_SLOT
	LDY $29
	LDX $27
	LDA $2D
	JSL INIT_ENTITY
	STA $02
	BRA @UNKNOWN6
@UNKNOWN5:
	STZ ENTITY_ALLOCATION_MIN_SLOT
	LDA #$0016
	STA ENTITY_ALLOCATION_MAX_SLOT
	LDY $29
	LDX $27
	LDA $2D
	JSL INIT_ENTITY
	STA $02
	ORA #$0080
	TAX
	LDA #$FFFF
	JSL ALLOC_SPRITE_MEM
@UNKNOWN6:
	LDA $02
	ASL
	TAY
	STY $1D
	LDA $1F
	CLC
	ADC #.LOWORD(SPRITE_TABLE_7E467E)
	STA ENTITY_SPRITEMAP_POINTER_LOW,Y
	LDA #.HIWORD(SPRITE_TABLE_7E467E)
	STA ENTITY_SPRITEMAP_POINTER_HIGH,Y
	LDA [$0A]
	AND #$00FF
	OPTIMIZED_MULT $04, 5
	STA ENTITY_UNKNOWN_2916,Y
	LDA $21
	STA ENTITY_UNKNOWN_2952,Y
	TYA
	CLC
	ADC #.LOWORD(ENTITY_VRAM_ADDRESS)
	TAX
	STX $1B
	LDA $21
	ASL
	TAX
	LDA f:UNKNOWN_C42F8C,X
	CLC
	ADC #$4000
	LDX $1B
	STA RAM,X
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0001
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	ASL
	LDY $1D
	STA ENTITY_BYTE_WIDTHS,Y
	LDA [$06]
	AND #$00FF
	STA ENTITY_TILE_HEIGHTS,Y
	MOVE_INT $23, $06
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0008
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	LDY $1D
	STA UNKNOWN_30X2_TABLE_31,Y
	LOADPTR SPRITE_GROUPING_PTR_TABLE, $06
	LDA $2B
	ASL
	ASL
	CLC
	ADC $06
	STA $06
	DEREFERENCE_PTR_TO $06, $06
	MOVE_INT $06, $12
	LDA $2B
	LDY $1D
	STA ENTITY_TPT_ENTRY_SPRITES,Y
	LDA $14
	STA ENTITY_GRAPHICS_PTR_HIGH,Y
	LDA $12
	CLC
	ADC #$0009
	STA ENTITY_GRAPHICS_PTR_LOW,Y
	LDA UNKNOWN_7E467C
	AND #$0001
	BEQ @UNKNOWN7
	LDA RAM,X
	CLC
	ADC #$0100
	STA RAM,X
@UNKNOWN7:
	LDA $02
	ASL
	TAX
	STX $1B
	MOVE_INT $23, $06
	INC $06
	INC $06
	MOVE_INT $06, $17
	LDA [$17]
	AND #$00FF
	STA ENTITY_SIZES,X
	MOVE_INT $23, $06
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0004
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA UNKNOWN_7E3366,X
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0005
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA UNKNOWN_7E33A2,X
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0006
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA UNKNOWN_7E33DE,X
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0007
	LDA [$06],Y
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA UNKNOWN_7E1A4A,X
	LDA [$17]
	AND #$00FF
	ASL
	TAX
	LDA f:UNKNOWN_C42AEB,X
	LDX $1B
	STA UNKNOWN_7E332A,X
	SEP #PROC_FLAGS::ACCUM8
	LDY #$0001
	LDA [$0A],Y
	STA $16
	STA $00
	LDA [$0A]
	SEC
	SBC $00
	REP #PROC_FLAGS::ACCUM8
	AND #$00FF
	STA $04
	LDA $16
	AND #$00FF
	XBA
	AND #$FF00
	ORA $04
	STA UNKNOWN_30X2_TABLE_38,X
	LDA #$FFFF
	STA UNKNOWN_30X2_TABLE_43,X
	STA ENTITY_ENEMY_ID,X
	STA ENTITY_TPT_ENTRIES,X
	STA ENTITY_COLLIDED_OBJECTS,X
	STZ ENTITY_SURFACE_FLAGS,X
	STZ UNKNOWN_30X2_TABLE_45,X
	STZ UNKNOWN_30X2_TABLE_44,X
	STZ UNKNOWN_30X2_TABLE_41,X
	STZ UNKNOWN_30X2_TABLE_35,X
	STZ ENTITY_DIRECTIONS,X
	STZ ENTITY_OBSTACLE_FLAGS,X
	LDA $02
@UNKNOWN8:
	PLD
	RTL
